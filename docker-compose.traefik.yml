# Traefik Override File
# Usage: docker compose -f docker-compose.yml -f docker-compose.traefik.yml up -d
#
# Prerequisites:
#   1. Traefik running with your certificate resolver configured
#   2. Create the traefik network: docker network create traefik
#   3. Set N8N_HOST in your .env file

networks:
  n8n_network:
    name: n8n_network
  traefik:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik}

services:
  n8n:
    networks:
      - n8n_network
      - traefik
    labels:
      # Enable Traefik
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik}
      
      # HTTP Router (redirect to HTTPS)
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}-http.rule=Host(`${N8N_HOST}`)
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}-http.entrypoints=${TRAEFIK_ENTRYPOINT_HTTP:-web}
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}-http.middlewares=${N8N_TRAEFIK_ROUTER:-n8n}-https-redirect
      
      # HTTPS Router
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}.rule=Host(`${N8N_HOST}`)
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}.entrypoints=${TRAEFIK_ENTRYPOINT_HTTPS:-websecure}
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}.tls=true
      - traefik.http.routers.${N8N_TRAEFIK_ROUTER:-n8n}.tls.certresolver=${TRAEFIK_CERTRESOLVER:-letsencrypt}
      
      # Service Configuration
      - traefik.http.services.${N8N_TRAEFIK_ROUTER:-n8n}.loadbalancer.server.port=5678
      
      # Middleware: HTTPS Redirect
      - traefik.http.middlewares.${N8N_TRAEFIK_ROUTER:-n8n}-https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.${N8N_TRAEFIK_ROUTER:-n8n}-https-redirect.redirectscheme.permanent=true
      
      # Middleware: Security Headers
      - traefik.http.middlewares.${N8N_TRAEFIK_ROUTER:-n8n}-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.${N8N_TRAEFIK_ROUTER:-n8n}-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.${N8N_TRAEFIK_ROUTER:-n8n}-headers.headers.stsPreload=true

