name: Build and Push n8n Custom Image

on:
  schedule:
    # Check for updates every 6 hours
    - cron: '0 */6 * * *'
  # Allow manual trigger
  workflow_dispatch:
  # Run on push to main branch
  push:
    branches:
      - main
    paths-ignore:
      - '.n8n-version'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_GITHUB }}

      - name: Get latest stable n8n version
        id: get-version
        run: |
          # Get the digest of the 'stable' tag
          STABLE_DIGEST=$(curl -s "https://hub.docker.com/v2/repositories/n8nio/n8n/tags/stable" | jq -r '.digest')
          echo "Stable tag digest: $STABLE_DIGEST"
          
          # Find which semantic version tag has the same digest as 'stable'
          # This ensures we're tracking the actual stable release version, not beta/pre-release
          LATEST_VERSION=$(curl -s "https://hub.docker.com/v2/repositories/n8nio/n8n/tags?page_size=100" | \
            jq -r --arg digest "$STABLE_DIGEST" \
            '.results[] | select(.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$")) | select(.digest == $digest) | .name' | \
            sort -V | tail -n1)
          
          # Fallback: if we can't find a matching version, use 'stable' tag directly
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" == "null" ]; then
            echo "Warning: Could not find version tag matching stable digest, using 'stable' tag"
            LATEST_VERSION="stable"
          fi
          
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
          echo "N8N_TAG=stable" >> $GITHUB_ENV
          echo "Latest stable n8n version: $LATEST_VERSION"
          
          # Create version file if it doesn't exist
          if [ ! -f .n8n-version ]; then
            echo "0.0.0" > .n8n-version
          fi
          
          CURRENT_VERSION=$(cat .n8n-version | tr -d '\n\r ' | xargs)
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "Current tracked version: $CURRENT_VERSION"
          
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "Update needed: $CURRENT_VERSION -> $LATEST_VERSION"
          else
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            echo "No update needed: versions match ($CURRENT_VERSION)"
          fi

      # Set up QEMU for multi-architecture builds
      - name: Set up QEMU
        if: env.UPDATE_NEEDED == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: env.UPDATE_NEEDED == 'true'
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        if: env.UPDATE_NEEDED == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract metadata for Docker
      - name: Extract Docker metadata
        if: env.UPDATE_NEEDED == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ env.LATEST_VERSION }}

      # Build and push multi-architecture image
      - name: Build and push
        if: env.UPDATE_NEEDED == 'true'
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            N8N_VERSION=${{ env.N8N_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Generate artifact attestation for supply chain security
      - name: Generate artifact attestation
        if: env.UPDATE_NEEDED == 'true'
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: Update version file
        if: env.UPDATE_NEEDED == 'true'
        run: |
          echo "${{ env.LATEST_VERSION }}" > .n8n-version
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add .n8n-version
          git commit -m "Update to n8n version ${{ env.LATEST_VERSION }}"
          
          # Use the PAT for pushing changes
          git push https://${{ secrets.PAT_GITHUB }}@github.com/${{ github.repository }}.git HEAD:main

      # Trigger Dokploy deployment webhook
      - name: Trigger Dokploy deployment
        if: env.UPDATE_NEEDED == 'true'
        continue-on-error: true
        run: |
          echo "Triggering Dokploy deployment webhook..."
          curl -X POST "${{ secrets.DOKPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ env.LATEST_VERSION }}",
              "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.LATEST_VERSION }}",
              "digest": "${{ steps.push.outputs.digest }}",
              "workflow_run": "${{ github.run_id }}",
              "commit": "${{ github.sha }}"
            }' \
            -f -s -S || echo "Warning: Dokploy webhook call failed (secret may not be set)"
